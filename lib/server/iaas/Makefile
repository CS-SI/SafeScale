GO?=go

BUILD_DATE := `date +%Y/%m/%d-%H:%M`
VERSIONFILE := version.go
REV := `git rev-parse HEAD 2>/dev/null || echo ""`

.PHONY:	clean generate vet

all: generate

generate:
	@(cd abstract && $(MAKE) $(@))
	@(cd providers && $(MAKE) $(@))
	@$(RM) $(VERSIONFILE) || true
	@echo "package iaas" > $(VERSIONFILE)
	@echo "// Build constants (autogenerated)" >> $(VERSIONFILE)
	@echo "const (" >> $(VERSIONFILE)
	@echo "    Version = \"$(VERSION)\"" >> $(VERSIONFILE)
	@echo "    BuildDate = \"$(BUILD_DATE)\"" >> $(VERSIONFILE)
	@echo "    Revision = \"$(REV)\"" >> $(VERSIONFILE)
	@echo ")" >> $(VERSIONFILE)

vet:
	@$(GO) vet $(BUILD_TAGS) ./...

clean:
	@(cd abstract && $(MAKE) $(@))
	@(cd stacks && $(MAKE) $(@))
	@(cd providers && $(MAKE) $(@))
	@$(RM) ./mocks/*.go || true
