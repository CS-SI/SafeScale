---
feature:
    name: sparkmaster
    suitableFor:
        host: yes
        cluster: all
    requirements:
        features:
            - docker
    install:
        bash:
            check:
                pace: image
                steps:
                    image:
                        targets:
                            masters: one
                        run: |
                            docker image ls {{ "--format '{{.Repository}}:{{.Tag}}'" }} | grep 'bidsraf/sparkmaster:latest' &>/dev/null

            add:
                pace: load,start
                steps:
                    load:
                        targets:
                            hosts: yes
                            masters: one
                        run: |
                            wget -q -O - https://storage.sbg3.cloud.ovh.net/v1/AUTH_e8f760594ab4429db04076280b5f3522/Demos/V1/containers/bidsraf_sparkmaster_latest.tar.gz | docker image load
                            docker network create -d overlay --attachable net-spark

                    start:
                        targets:
                            hosts: yes
                            masters: one
                        run: |
                            docker run -d \
                                       --name bidsraf-sparkmaster --hostname bidsraf-sparkmaster \
                                       --restart always \
                                       -p 8081:8081 -p 7077:7077 \
                                       --network net-spark \
                                       bidsraf/sparkmaster:latest

            remove:
                pace: container,image
                steps:
                    container:
                        targets:
                            hosts: yes
                            masters: all
                        run: |
                            for c in $(docker container ps {{ "--format '{{.ID}} {{.Image}}'" }} | grep 'bidsraf/sparkmaster:latest'); do
                                docker container stop $c &>/dev/null || :
                                docker container rm -f $c &>/dev/null || :
                            done

                    image:
                        targets:
                            hosts: yes
                            masters: all
                        run: |
                            docker image rm -f bidsraf/sparkmaster:latest

...
