#
# Copyright 2018-2019, CS Systemes d'Information, http://www.c-s.fr
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---
feature:
    suitableFor:
        host: yes
        cluster: all
    requirements:
        features:
            - docker
            - docker-compose

    install:
        bash:
            check:
                pace: curl
                steps:
                    curl:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            curl -Ssl -I -k https://localhost:8444/ 2>&1 | grep "HTTP/1.1 200 OK" &>/dev/null

            add:
                pace: config,networks,start
                steps:
                    config:
                        timeout: 10
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            mkdir -p ${SF_VARDIR}/kong/postgresql ${SF_ETCDIR}/kong/includes

                            cat >${SF_ETCDIR}/kong/Dockerfile <<-'EOF'
                            FROM kong:1.1
                            RUN apk update && apk add git unzip
                            RUN luarocks install kong-oidc \
                             && luarocks install kong-prometheus-plugin
                            RUN mkdir -p /etc/kong/includes
                            RUN setcap CAP_NET_BIND_SERVICE=+ep /usr/local/openresty/nginx/sbin/nginx
                            EOF

                            {{ if .ClusterFlavor }}
                            TAG=kong4safescale
                            {{ else }}
                            TAG=kong
                            {{ end }}
                            docker build -t $TAG ${SF_ETCDIR}/kong

                            cat >${SF_ETCDIR}/kong/konga.userdb.data <<-EOF
                            module.exports = [
                                {
                                    "username": "cladm",
                                    "email": "cladm@safescale",
                                    "firstName": "Cluster",
                                    "lastName": "Administrator",
                                    "node_id": "https://127.0.0.1:8444",
                                    "admin": true,
                                    "active" : true,
                                    "password": "{{.Password}}"
                                }
                            ]
                            EOF
                            chmod go-rwx ${SF_ETCDIR}/kong/konga.userdb.data

                            DB_PASSWORD="$(sfRandomString 16 "[:alnum:]")"

                            {{ if .ClusterFlavor }}
                            IMAGE=kong4safescale
                            KONG_PUB_BRIDGE=br_k4s_pub
                            KONG_DB_BRIDGE=br_k4s_db
                            {{ else }}
                            IMAGE=kong
                            KONG_PUB_BRIDGE=br_k_pub
                            KONG_BRIDGE=br_k_db
                            {{ end}}
                            KONG_PUB_NET="${IMAGE}_pubnet"
                            KONG_DB_NET="${IMAGE}_dbnet"

                            cat >${SF_ETCDIR}/kong/docker-compose.yml <<-EOF
                            version: '2.1'
                            services:
                                db:
                                    image: postgres:9
                                    environment:
                                        - POSTGRES_DB=kong
                                        - POSTGRES_USER=kong
                                        - POSTGRES_PASSWORD="${DB_PASSWORD}"
                                    volumes:
                                        - ${SF_VARDIR}/kong/postgresql:/var/lib/postgresql/data
                                    networks:
                                        ${KONG_DB_NET}:
                                    restart: always
                                    healthcheck:
                                        test: ["CMD", "pg_isready", "-U", "kong"]
                                        interval: 10s
                                        timeout: 5s
                                        retries: 5

                                migration:
                                    image: kong:1.1
                                    environment:
                                        - KONG_DATABASE=postgres
                                        - KONG_PG_HOST=db
                                        - KONG_PG_USER=kong
                                        - KONG_PG_PASSWORD="${DB_PASSWORD}"
                                    command: kong migrations bootstrap # up
                                    networks:
                                        ${KONG_DB_NET}:
                                    depends_on:
                                        db:
                                            condition: service_healthy

                                proxy:
                                    image: ${IMAGE}
                                    environment:
                                        - KONG_DATABASE=postgres
                                        - KONG_PG_HOST=db
                                        - KONG_PG_DATABASE=kong
                                        - KONG_PG_USER=kong
                                        - KONG_PG_PASSWORD="${DB_PASSWORD}"
                                        - KONG_PROXY_ACCESS_LOG=/dev/stdout
                                        - KONG_ADMIN_ACCESS_LOG=/dev/stdout
                                        - KONG_PROXY_ERROR_LOG=/dev/stderr
                                        - KONG_ADMIN_ERROR_LOG=/dev/stderr
                                        - KONG_ADMIN_LISTEN=0.0.0.0:8444 ssl
                                        - KONG_PROXY_LISTEN=0.0.0.0:443 ssl
                                        - KONG_PLUGINS=oidc,prometheus
                                    volumes:
                                        - ${SF_ETCDIR}/kong/kong.conf:/etc/kong/kong.conf:ro
                                        - ${SF_ETCDIR}/kong/includes:/etc/kong/includes:ro
                                    networks:
                                        ${KONG_PUB_NET}:
                                        ${KONG_DB_NET}:
                                    ports:
                                        - "443:443"
                                        - "127.0.0.1:8444:8444"
                                        - "{{.GatewayIP}}:6443:6443"
                                    depends_on:
                                        db:
                                            condition: service_healthy
                                        migration:
                                            condition: service_started
                                    restart: always
                                    healthcheck:
                                        test: ["CMD-SHELL", "curl -I -s -k -L https://127.0.0.1:8444 || exit 1"]
                                        interval: 5s
                                        retries: 10

                                # gui:
                                #     image: pantsel/konga
                                #     volumes:
                                #         - ${SF_ETCDIR}/kong/konga.userdb.data:/usr/local/etc/userdb.data:ro
                                #     environment:
                                #         - TOKEN_SECRET="$(sfRandomString 32 [:alnum:])"
                                #         - DB_ADAPTER=postgres
                                #         - DB_DATABASE=kong-gui
                                #         - DB_USER=kong
                                #         - DB_PASSWORD="${DB_PASSWORD}"
                                #         - NODE_ENV=production
                                #         - KONGA_SEED_USER_DATA_SOURCE_FILE=/usr/local/etc/userdb.data
                                #     networks:
                                #         ${KONG_PUB_NET}:
                                #         ${KONG_DB_NET}:
                                #     ports:
                                #         - "{{.HostIP}}:1337:1337"
                                #     restart: always
                                #     depends_on:
                                #         db:
                                #             condition: service_healthy
                                #         proxy:
                                #             condition: service_started

                            networks:
                                ${KONG_PUB_NET}:
                                    external: true
                                ${KONG_DB_NET}:
                                    external: true
                            EOF
                            chmod go-rwx ${SF_ETCDIR}/kong/docker-compose.yml

                            cat >${SF_ETCDIR}/kong/kong.conf <<-EOF
                            stream_listen = 0.0.0.0:6442
                            nginx_stream_include = /etc/kong/includes/*.conf
                            anonymous_reports = off
                            EOF

                    networks:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            {{ if .ClusterFlavor }}
                            IMAGE=kong4safescale
                            KONG_PUB_BRIDGE=br_k4s_pub
                            KONG_DB_BRIDGE=br_k4s_db
                            {{ else }}
                            IMAGE=kong
                            KONG_PUB_BRIDGE=br_k_pub
                            KONG_DB_BRIDGE=br_k_db
                            {{ end}}
                            KONG_PUB_NET="${IMAGE}_pubnet"
                            KONG_DB_NET="${IMAGE}_dbnet"

                            docker network create --driver bridge --attachable --opt "com.docker.network.bridge.name=${KONG_PUB_BRIDGE}" ${KONG_PUB_NET}
                            docker network create --driver bridge --attachable --internal --opt "com.docker.network.bridge.name=${KONG_DB_BRIDGE}" ${KONG_DB_NET}

                            sfFirewallAdd --zone=trusted --add-interface=${KONG_PUB_BRIDGE} && \
                            sfFirewallAdd --zone=trusted --add-interface=${KONG_DB_BRIDGE} && \
                            sfFirewallAdd --zone=public --add-service=https && \
                            sfFirewallReload

                    start:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            {{ if .ClusterFlavor }}
                            IMAGE=kong4safescale
                            OPTIONS="-p ${IMAGE}"
                            {{ else }}
                            IMAGE=kong
                            OPTIONS=
                            {{ end}}

                            docker-compose -f ${SF_ETCDIR}/kong/docker-compose.yml $OPTIONS up -d || exit 192
                            sfRetry 5m 5 "docker ps --all | grep ${IMAGE}_migration_1 | grep Exited" || exit 193
                            exit 0

            remove:
                pace: compose,networks
                steps:
                    compose:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            {{ if .ClusterFlavor }}
                            OPTIONS="-p kong4safescale"
                            {{ else }}
                            OPTIONS=
                            {{ end }}
                            docker-compose -f ${SF_ETCDIR}/kong/docker-compose.yml $OPTIONS rm --stop -v --force || exit 192
                            rm -rf ${SF_ETCDIR}/kong/docker-compose.yml ${SF_VARDIR}/kong

                    networks:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            {{ if .ClusterFlavor }}
                            KONG_PUB_BRIDGE=br_k4s_pub
                            KONG_DB_BRIDGE=br_k4s_db
                            {{ else }}
                            KONG_PUB_BRIDGE=br_k_pub
                            KONG_BRIDGE=br_k_db
                            {{ end}}

                            sfFirewallAdd --zone=public --remove-service=https && \
                            sfFirewallAdd --zone=trusted --remove-interface=${KONG_PUB_BRIDGE} && \
                            sfFirewallAdd --zone=trusted --remove-interface=${KONG_DB_BRIDGE} && \
                            sfFirewallReload

                            docker network rm ${KONG_PUB_BRIDGE}
                            docker network rm ${KONG_DB_BRIDGE}
                            exit 0

...