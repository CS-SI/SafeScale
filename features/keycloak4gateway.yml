#
# Copyright 2018-2019, CS Systemes d'Information, http://www.c-s.fr
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---
feature:
    suitableFor:
        host: no
        cluster: all
    requirements:
        features:
            - postgres4gateway
    parameters:
        - KeycloakAdminPassword

    install:
        bash:
            check:
                pace: curl
                steps:
                    curl:
                        targets:
                            hosts: no
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            curl -Ssl -I -k https://{{ .HostIP }}:8443/auth/ 2>&1 | grep "HTTP/2 200" &>/dev/null

            add:
                # pace: config,build,secret,compose,start
                pace: config,build,compose,start
                steps:
                    config:
                        timeout: 10
                        targets:
                            hosts: no
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            mkdir -p ${SF_ETCDIR}/keycloak4gateway

                            cat >${SF_ETCDIR}/keycloak4gateway/standalone-ha.xml.patch <<-'EOF'
                            --- standalone-ha.xml	2019-07-10 15:45:31.706239257 +0200
                            +++ standalone-ha.xml.new	2019-07-10 15:46:06.850275164 +0200
                            @@ -52,6 +52,13 @@
                                                <properties path="application-roles.properties" relative-to="jboss.server.config.dir"/>
                                            </authorization>
                                        </security-realm>
                            +            <security-realm name="KeycloakRealm">
                            +                <server-identities>
                            +                    <ssl>
                            +                        <keystore path="safescale.jks" relative-to="jboss.server.config.dir" keystore-password="safescale" />
                            +                    </ssl>
                            +                </server-identities>
                            +            </security-realm>
                                    </security-realms>
                                    <audit-log>
                                        <formatters>
                            @@ -126,18 +133,29 @@
                                                    <password>sa</password>
                                                </security>
                                            </datasource>
                            -                <datasource jndi-name="java:jboss/datasources/KeycloakDS" pool-name="KeycloakDS" enabled="true" use-java-context="true">
                            -                    <connection-url>jdbc:h2:${jboss.server.data.dir}/keycloak;AUTO_SERVER=TRUE</connection-url>
                            -                    <driver>h2</driver>
                            +                <datasource jndi-name="java:jboss/datasources/KeycloakDS" pool-name="KeycloakDS" enabled="true" use-java-context="true" use-ccm="true">
                            +                    <connection-url>jdbc:postgresql://${env.DB_ADDR:postgres}:${env.DB_PORT:5432}/${env.DB_DATABASE:keycloak}${env.JDBC_PARAMS:}</connection-url>
                            +                    <driver>postgresql</driver>
                            +                    <pool>
                            +                        <flush-strategy>IdleConnections</flush-strategy>
                            +                    </pool>
                                                <security>
                            -                        <user-name>sa</user-name>
                            -                        <password>sa</password>
                            +                        <user-name>${env.DB_USER:keycloak}</user-name>
                            +                        <password>${env.DB_PASSWORD:password}</password>
                                                </security>
                            +                    <validation>
                            +                        <check-valid-connection-sql>SELECT 1</check-valid-connection-sql>
                            +                        <background-validation>true</background-validation>
                            +                        <background-validation-millis>60000</background-validation-millis>
                            +                    </validation>
                                            </datasource>
                                            <drivers>
                                                <driver name="h2" module="com.h2database.h2">
                                                    <xa-datasource-class>org.h2.jdbcx.JdbcDataSource</xa-datasource-class>
                                                </driver>
                            +                    <driver name="postgresql" module="org.postgresql.jdbc">
                            +                        <xa-datasource-class>org.postgresql.xa.PGXADataSource</xa-datasource-class>
                            +                    </driver>
                                            </drivers>
                                        </datasources>
                                    </subsystem>
                            @@ -590,11 +608,11 @@
                                        <buffer-cache name="default"/>
                                        <server name="default-server">
                                            <ajp-listener name="ajp" socket-binding="ajp"/>
                            -                <http-listener name="default" socket-binding="http" redirect-socket="https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" enable-http2="true"/>
                            -                <https-listener name="https" socket-binding="https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" security-realm="ApplicationRealm" enable-http2="true"/>
                            +                <http-listener name="default" socket-binding="http" redirect-socket="proxy-https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" enable-http2="true"/>
                            +                <https-listener name="https" socket-binding="https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" security-realm="KeycloakRealm" enable-http2="true"/>
                                            <host name="default-host" alias="localhost">
                                                <location name="/" handler="welcome-content"/>
                            -                    <http-invoker security-realm="ApplicationRealm"/>
                            +                    <http-invoker security-realm="KeycloakRealm"/>
                                            </host>
                                        </server>
                                        <servlet-container name="default">
                            @@ -629,8 +647,9 @@
                                    <socket-binding name="modcluster" multicast-address="${jboss.modcluster.multicast.address:224.0.1.105}" multicast-port="23364"/>
                                    <socket-binding name="txn-recovery-environment" port="4712"/>
                                    <socket-binding name="txn-status-manager" port="4713"/>
                            +        <socket-binding name="proxy-https" port="443"/>
                                    <outbound-socket-binding name="mail-smtp">
                                        <remote-destination host="localhost" port="25"/>
                                    </outbound-socket-binding>
                                </socket-binding-group>
                            -</server>
                            \ Pas de fin de ligne Ã  la fin du fichier
                            +</server>
                            EOF

                    build:
                        timeout: 10
                        targets:
                            hosts: no
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            cat >${SF_ETCDIR}/keycloak4gateway/my-docker-entrypoint.sh <<-'EOF'
                            #!/bin/bash

                            case ${DB_VENDOR,,} in
                                postgres) ADMIN_PG_PASSWORD="$(cat /run/secrets/postgres4gateway)"
                                          export DB_PASSWORD="$(cat /run/secrets/keycloak4gateway-db)"

                                          cat >/root/.pgpass <<-EOF2
                            *:5432:*:postgres:$ADMIN_PG_PASSWORD
                            *:5432:keycloak4gateway:keycloak4gateway:$KEYCLOAK_PG_PASSWORD
                            EOF2
                                          chmod 0600 /root/.pgpass

                                          # wait for database server
                                          while ! psql -h $DB_ADDR -U postgres -c 'select 1' >/dev/null; do
                                              sleep 5
                                          done

                                          # Create database if needed
                                          if ! psql -h $DB_ADDR -U postgres ${DB_DATABASE} -c '\q' &>/dev/null; then
                                              psql -h $DB_ADDR -U postgres <<-EOSQL
                            CREATE DATABASE ${DB_DATABASE};
                            CREATE USER ${DB_USER};
                            EOSQL
                                          fi

                                          # Update ownership and DB_USER password
                                          psql -h $DB_ADDR -U postgres <<-EOSQL
                            ALTER USER ${DB_USER} PASSWORD '${DB_PASSWORD}';
                            ALTER DATABASE ${DB_DATABASE} OWNER TO ${DB_USER};
                            EOSQL
                                          ;;
                            esac

                            exec /opt/jboss/tools/docker-entrypoint.sh $*
                            EOF

                            cat >${SF_ETCDIR}/keycloak4gateway/Dockerfile <<-'EOF'
                            FROM jboss/keycloak:4.8.3.Final

                            WORKDIR /opt/jboss
                            USER root

                            # need psql in my-docker-entrypoint.sh and patch
                            RUN yum install -qy postgresql patch

                            # Generates SSL certificates
                            RUN openssl req -x509 -newkey rsa:4096 -keyout safescale_key.pem -out safescale_cert.pem -days 90 -nodes -subj "/C=FR/ST=France/O=CS-SI/CN={{ .HostIP }}" \
                             && openssl pkcs12 -export -name server-cert -in safescale_cert.pem -inkey safescale_key.pem -out safescale_keystore.p12 -password pass:safescale \
                             && keytool -importkeystore -destkeystore safescale.jks -srckeystore safescale_keystore.p12 -srcstoretype pkcs12 -alias server-cert -storepass safescale -keypass safescale -srcstorepass safescale \
                             && cp ./safescale.jks keycloak/standalone/configuration/ \
                             && chown jboss:jboss keycloak/standalone/configuration/safescale.jks

                            # Updates configuration
                            COPY standalone-ha.xml.patch keycloak/standalone/configuration/
                            RUN cd keycloak/standalone/configuration/ \
                             && patch -l <./standalone-ha.xml.patch \
                             && chown jboss:jboss standalone-ha.xml

                            COPY my-docker-entrypoint.sh /
                            RUN chmod 0550 /my-docker-entrypoint.sh
                            ENTRYPOINT [ "/my-docker-entrypoint.sh" ]
                            CMD ["-b", "0.0.0.0"]
                            EOF

                            docker build -t keycloak4gateway:latest ${SF_ETCDIR}/keycloak4gateway || exit 192

                    # secret:
                    #     targets:
                    #         hosts: no
                    #         gateways: any
                    #         masters: no
                    #         nodes: no
                    #     run: |
                    #         docker secret rm keycloak4gateway-db keycloak4gateway-admin &>/dev/null || true
                    #         echo -n "$(sfRandomString 16 "[:alnum:]")" | docker secret create keycloak4gateway-db - || exit 193
                    #         echo -n "{{ .KeycloakAdminPassword }}" | docker secret create keycloak4gateway-admin - || exit 193
                    #         exit 0

                    compose:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            KEYCLOAK_PG_PASSWORD="$(sfRandomString 16 "[:alnum:]")"
                            ADMIN_PG_PASSWORD="$(cat ${SF_ETCDIR}/postgres4gateway/password)"

                            cat >${SF_ETCDIR}/keycloak4gateway/docker-compose.yml <<-EOF
                            version: '2.1'
                            services:
                                server:
                                    image: keycloak4gateway
                                    environment:
                                        - DB_VENDOR=POSTGRES
                                        - DB_ADDR={{ .HostIP }}
                                        - DB_DATABASE=keycloak4gateway
                                        - DB_USER=keycloak4gateway
                                        - DB_PASSWORD=${KEYCLOAK_PG_PASSWORD}
                                        - ADMIN_PG_PASSWORD=${ADMIN_PG_PASSWORD}
                                        - KEYCLOAK_USER=admin
                                        - KEYCLOAK_PASSWORD={{ .KeycloakAdminPassword }}
                                        - PROXY_ADDRESS_FORWARDING=true
                                        # - KEYCLOAK_LOGLEVEL=DEBUG
                                        # - ROOT_LOGLEVEL=DEBUG
                                    network_mode: "host"
                                    ports:
                                        - {{ .HostIP }}:8443:8443
                                    restart: always
                                    # deploy:
                                    #     mode: global
                                    #     placement:
                                    #         constraints:
                                    #             - node.role == manager
                                    #     restart_policy:
                                    #         condition: on-failure
                                    #         delay: 5s
                                    #         max_attempts: 3
                                    #         window: 120s
                            #         secrets:
                            #             - postgres4gateway
                            #             - keycloak4gateway-db
                            #             - keycloak4gateway-admin

                            # secrets:
                            #     postgres4gateway:
                            #         external: true
                            #     keycloak4gateway-db:
                            #         external: true
                            #     keycloak4gateway-admin:
                            #         external: true

                            # networks:
                            #     safescale-gw:
                            #         external: true
                            EOF

                    start:
                        targets:
                            gateways: any
                            hosts: yes
                            masters: no
                            nodes: no
                        run: |
                            docker-compose -f ${SF_ETCDIR}/keycloak4gateway/docker-compose.yml -p keycloak4gateway up -d || exit 194
                            sfRetry 5m 5 "sfDoesDockerRun keycloak4gateway:latest keycloak4gateway_server_1" || exit 195
                            exit 0

            remove:
                pace: compose,cleanup
                steps:
                    compose:
                        targets:
                            gateways: all
                            hosts: yes
                            masters: no
                            nodes: no
                        run: |
                            docker-compose -f ${SF_ETCDIR}/keycloak4gateway/docker-compose -p keycloak4gateway rm --stop --force || exit 196
                            exit 0

                    cleanup:
                        targets:
                            hosts: yes
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            docker secret rm keycloak4gateway-db keycloak4gateway-admin
                            docker image rm -f keycloak4gateway:latest
                            rm -drf ${SF_ETCDIR}/keycloak4gateway ${SF_VARDIR}/keycloak4gateway

    proxy:
        rules:
            - name: keycloak4gateway_backend
              type: upstream
              targets:
                  gateways: all
              content: |
                  {
                      "target": "{{.HostIP}}:8443",
                      "weight": 100
                  }

            - name: keycloak4gateway_svc
              type: service
              targets:
                  gateways: any
              content: |
                  {
                      "protocol": "https",
                      "host": "keycloak4gateway_backend"
                  }

            - name: keycloak4gateway_route
              type: route
              targets:
                  gateways: any
              content: |
                  {
                        "paths": [ "/auth/" ],
                        "strip_path": false,
                        "protocols":["https"],
                        "service": { "id": "{{.keycloak4gateway_svc}}" }
                  }

...
