#
# Copyright 2018-2019, CS Systemes d'Information, http://www.c-s.fr
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---
feature:
    suitableFor:
        host: no
        cluster: all
    requirements:
        features:
            - postgresql4platform

    parameters:
        - KeycloakAdminPassword

    install:
        bash:
            check:
                pace: curl
                steps:
                    curl:
                        targets:
                            hosts: no
                            gateways: all
                            masters: no
                            nodes: no
                        run: |
                            curl -Ssl -I -k https://{{ .DefaultRouteIP }}:63009/auth/ 2>&1 | grep "HTTP/2 200" &>/dev/null

            add:
                pace: config,build,secrets,stack,start
                steps:
                    config:
                        timeout: 10
                        targets:
                            gateways: all
                        run: |
                            mkdir -p ${SF_ETCDIR}/keycloak4gateway

                            cat >${SF_ETCDIR}/keycloak4gateway/standalone-ha.xml.patch <<-'EOF'
                            --- standalone-ha.xml	2019-07-10 15:45:31.706239257 +0200
                            +++ standalone-ha.xml.new	2019-07-10 15:46:06.850275164 +0200
                            @@ -52,6 +52,13 @@
                                                <properties path="application-roles.properties" relative-to="jboss.server.config.dir"/>
                                            </authorization>
                                        </security-realm>
                            +            <security-realm name="KeycloakRealm">
                            +                <server-identities>
                            +                    <ssl>
                            +                        <keystore path="safescale.jks" relative-to="jboss.server.config.dir" keystore-password="safescale" />
                            +                    </ssl>
                            +                </server-identities>
                            +            </security-realm>
                                    </security-realms>
                                    <audit-log>
                                        <formatters>
                            @@ -126,18 +133,29 @@
                                                    <password>sa</password>
                                                </security>
                                            </datasource>
                            -                <datasource jndi-name="java:jboss/datasources/KeycloakDS" pool-name="KeycloakDS" enabled="true" use-java-context="true">
                            -                    <connection-url>jdbc:h2:${jboss.server.data.dir}/keycloak;AUTO_SERVER=TRUE</connection-url>
                            -                    <driver>h2</driver>
                            +                <datasource jndi-name="java:jboss/datasources/KeycloakDS" pool-name="KeycloakDS" enabled="true" use-java-context="true" use-ccm="true">
                            +                    <connection-url>jdbc:postgresql://${env.DB_ADDR:postgres}:${env.DB_PORT:5432}/${env.DB_DATABASE:keycloak}${env.JDBC_PARAMS:}</connection-url>
                            +                    <driver>postgresql</driver>
                            +                    <pool>
                            +                        <flush-strategy>IdleConnections</flush-strategy>
                            +                    </pool>
                                                <security>
                            -                        <user-name>sa</user-name>
                            -                        <password>sa</password>
                            +                        <user-name>${env.DB_USER:keycloak}</user-name>
                            +                        <password>${env.DB_PASSWORD:password}</password>
                                                </security>
                            +                    <validation>
                            +                        <check-valid-connection-sql>SELECT 1</check-valid-connection-sql>
                            +                        <background-validation>true</background-validation>
                            +                        <background-validation-millis>60000</background-validation-millis>
                            +                    </validation>
                                            </datasource>
                                            <drivers>
                                                <driver name="h2" module="com.h2database.h2">
                                                    <xa-datasource-class>org.h2.jdbcx.JdbcDataSource</xa-datasource-class>
                                                </driver>
                            +                    <driver name="postgresql" module="org.postgresql.jdbc">
                            +                        <xa-datasource-class>org.postgresql.xa.PGXADataSource</xa-datasource-class>
                            +                    </driver>
                                            </drivers>
                                        </datasources>
                                    </subsystem>
                            @@ -590,11 +608,11 @@
                                        <buffer-cache name="default"/>
                                        <server name="default-server">
                                            <ajp-listener name="ajp" socket-binding="ajp"/>
                            -                <http-listener name="default" socket-binding="http" redirect-socket="https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" enable-http2="true"/>
                            -                <https-listener name="https" socket-binding="https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" security-realm="ApplicationRealm" enable-http2="true"/>
                            +                <http-listener name="default" socket-binding="http" redirect-socket="proxy-https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" enable-http2="true"/>
                            +                <https-listener name="https" socket-binding="https" proxy-address-forwarding="${env.PROXY_ADDRESS_FORWARDING:false}" security-realm="KeycloakRealm" enable-http2="true"/>
                                            <host name="default-host" alias="localhost">
                                                <location name="/" handler="welcome-content"/>
                            -                    <http-invoker security-realm="ApplicationRealm"/>
                            +                    <http-invoker security-realm="KeycloakRealm"/>
                                            </host>
                                        </server>
                                        <servlet-container name="default">
                            @@ -629,8 +647,9 @@
                                    <socket-binding name="modcluster" multicast-address="${jboss.modcluster.multicast.address:224.0.1.105}" multicast-port="23364"/>
                                    <socket-binding name="txn-recovery-environment" port="4712"/>
                                    <socket-binding name="txn-status-manager" port="4713"/>
                            +        <socket-binding name="proxy-https" port="443"/>
                                    <outbound-socket-binding name="mail-smtp">
                                        <remote-destination host="localhost" port="25"/>
                                    </outbound-socket-binding>
                                </socket-binding-group>
                            -</server>
                            \ Pas de fin de ligne Ã  la fin du fichier
                            +</server>
                            EOF

                    build:
                        timeout: 10
                        targets:
                            gateways: all
                        run: |
                            cat >${SF_ETCDIR}/keycloak4gateway/my-docker-entrypoint.sh <<-EOF
                            #!/bin/bash

                            export KEYCLOAK_USER=admin
                            export KEYCLOAK_PASSWORD=\$(cat /run/secrets/password.admin)

                            export DB_ADDR={{ .DefaultRouteIP }}
                            export DB_PORT=63008
                            export DB_VENDOR=postgres
                            export DB_DATABASE=keycloak4gateway
                            #FIXME: Using postgres user because for now keycloak4gateway doesn't have enough rights to do the job
                            # export DB_USER=keycloak4gateway
                            export DB_USER=postgres
                            export DB_PASSWORD=\$(cat /run/secrets/password.postgres)

                            export ADMIN_DB_PASSWORD=\$(cat /run/secrets/password.postgres)

                            cat >/root/.pgpass <<-EOF2
                            *:5432:*:postgres:\$ADMIN_DB_PASSWORD
                            *:5432:keycloak4gateway:keycloak4gateway:\$DB_PASSWORD
                            EOF2
                            chmod 0600 /root/.pgpass

                            # Generates SSL certificates
                            IP=\$(ifconfig eth0 | grep inet | tr -s ' ' '#' | cut -d\# -f3 | head -n 1)
                                openssl req -x509 -newkey rsa:4096 -keyout safescale_key.pem -out safescale_cert.pem -days 90 -nodes -subj "/C=FR/ST=France/O=CS-SI/CN=\$IP" \
                             && openssl pkcs12 -export -name server-cert -in safescale_cert.pem -inkey safescale_key.pem -out safescale_keystore.p12 -password pass:safescale \
                             && keytool -importkeystore -destkeystore safescale.jks -srckeystore safescale_keystore.p12 -srcstoretype pkcs12 -alias server-cert -storepass safescale -keypass safescale -srcstorepass safescale \
                             && cp ./safescale.jks /opt/jboss/keycloak/standalone/configuration/ \
                             && chown jboss:jboss /opt/jboss/keycloak/standalone/configuration/safescale.jks

                            exec /opt/jboss/tools/docker-entrypoint.sh "\$@"
                            EOF

                            cat >${SF_ETCDIR}/keycloak4gateway/Dockerfile <<-'EOF'
                            FROM jboss/keycloak:4.8.3.Final

                            WORKDIR /opt/jboss
                            USER root

                            # need psql in my-docker-entrypoint.sh and patch
                            RUN yum install -q -y postgresql patch net-tools

                            # # Generates SSL certificates
                            # RUN openssl req -x509 -newkey rsa:4096 -keyout safescale_key.pem -out safescale_cert.pem -days 90 -nodes -subj "/C=FR/ST=France/O=CS-SI/CN={{ .HostIP }}" \
                            #  && openssl pkcs12 -export -name server-cert -in safescale_cert.pem -inkey safescale_key.pem -out safescale_keystore.p12 -password pass:safescale \
                            #  && keytool -importkeystore -destkeystore safescale.jks -srckeystore safescale_keystore.p12 -srcstoretype pkcs12 -alias server-cert -storepass safescale -keypass safescale -srcstorepass safescale \
                            #  && cp ./safescale.jks keycloak/standalone/configuration/ \
                            #  && chown jboss:jboss keycloak/standalone/configuration/safescale.jks

                            # Updates configuration
                            COPY standalone-ha.xml.patch keycloak/standalone/configuration/
                            RUN cd keycloak/standalone/configuration/ \
                             && patch -l <./standalone-ha.xml.patch \
                             && chown jboss:jboss standalone-ha.xml

                            COPY my-docker-entrypoint.sh /
                            RUN chmod 0550 /my-docker-entrypoint.sh
                            ENTRYPOINT [ "/my-docker-entrypoint.sh" ]
                            CMD ["-b", "0.0.0.0"]
                            EOF

                            docker build --network host -t keycloak4gateway:latest ${SF_ETCDIR}/keycloak4gateway || exit 192

                    secrets:
                        targets:
                            masters: any
                        run: |
                            if docker secret inspect safescale.keycloak.password.dbuser &>/dev/null; then
                                docker secret rm safescale.keycloak.password.dbuser
                            fi
                            KC_PASSWORD=$(sfRandomString 16 "[:alnum:]")
                            echo -n "$KC_PASSWORD" | docker secret create safescale.keycloak.password.dbuser - || exit 193
                            if docker secret inspect safescale.keycloak.password.admin &>/dev/null; then
                                docker secret rm safescale.keycloak.password.admin
                            fi
                            echo -n "{{ .KeycloakAdminPassword }}" | docker secret create safescale.keycloak.password.admin - || exit 194

                            echo -n $KC_PASSWORD | sfPgsqlCreateRole keycloak4gateway LOGIN || exit 195
                            sfPgsqlCreateDatabase keycloak4gateway keycloak4gateway || exit 196
                            exit 0

                    stack:
                        targets:
                            masters: all
                        run: |
                            mkdir -p ${SF_ETCDIR}/keycloak4gateway

                            cat >${SF_ETCDIR}/keycloak4gateway/stack.yml <<-EOF
                            version: '3.7'
                            services:
                                server:
                                    image: keycloak4gateway:latest
                                    environment:
                                        - PROXY_ADDRESS_FORWARDING=true
                                        # - KEYCLOAK_LOGLEVEL=DEBUG
                                        # - ROOT_LOGLEVEL=DEBUG
                                    ports:
                                        - published: 63009
                                          target: 8443
                                          mode: host
                                    deploy:
                                        mode: global
                                        placement:
                                            constraints:
                                                - node.labels.safescale.host.role == gateway
                                        restart_policy:
                                            condition: on-failure
                                            delay: 5s
                                            max_attempts: 3
                                            window: 120s
                                    secrets:
                                        - password.postgres
                                        - password.dbuser
                                        - password.admin

                            secrets:
                                password.postgres:
                                    external: true
                                    name: safescale.postgresql.password.postgres
                                password.dbuser:
                                    external: true
                                    name: safescale.keycloak.password.dbuser
                                password.admin:
                                    external: true
                                    name: safescale.keycloak.password.admin
                            EOF

                    start:
                        targets:
                            masters: any
                        run: |
                            docker stack deploy -c ${SF_ETCDIR}/keycloak4gateway/stack.yml keycloak4gateway || exit 197
                            sfRetry 5m 5 "sfDoesDockerRunStack keycloak4gateway" || exit 198
                            exit 0

            remove:
                pace: stack,db,image,cleanup
                steps:
                    stack:
                        targets:
                            masters: any
                        run: |
                            docker stack rm keycloak4gateway || exit 199
                            docker secret rm safescale.keycloak.password.dbuser || true
                            docker secret rm safescale.keycloak.password.admin || true
                            exit 0

                    db:
                        targets:
                            masters: any
                        run: |
                            sfPgsqlDropDatabase keycloak4gateway || exit 200
                            sfPgsqlDropRole keycloak4gateway || exit 201
                            exit 0

                    image:
                        targets:
                            gateways: all
                        run: |
                            docker image rm -f keycloak4gateway:latest || true
                            exit 0

                    cleanup:
                        targets:
                            gateways: all
                            masters: all
                        run: |
                            rm -drf ${SF_ETCDIR}/keycloak4gateway ${SF_VARDIR}/keycloak4gateway
                            exit 0

    proxy:
        rules:
            - name: keycloak4gateway_backend
              type: upstream
              targets:
                  gateways: all
              content: |
                  {
                      "target": "{{.HostIP}}:63009",
                      "weight": 100
                  }

            - name: keycloak4gateway_svc
              type: service
              targets:
                  gateways: any
              content: |
                  {
                      "protocol": "https",
                      "host": "keycloak4gateway_backend"
                  }

            - name: keycloak4gateway_route
              type: route
              targets:
                  gateways: any
              content: |
                  {
                        "paths": [ "/auth/" ],
                        "strip_path": false,
                        "protocols":["https"],
                        "service": { "id": "{{ .keycloak4gateway_svc }}" }
                  }

...
