# Copyright 2018-2020, CS Systemes d'Information, http://www.c-s.fr
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
feature:
    suitableFor:
        host: no
        cluster: all

    requirements:
        features:
            - docker
            - certificateauthority

        # "clusterSizing" not honored currently
        clusterSizing:
            boh:
                small:
                    masters: "count >= 1, cpu >= 2"
                    nodes:   "count >= 1, cpu >= 2"
                normal:
                    masters: "count >= 3, cpu >= 2"
                    nodes:   "count >= 1, cpu >= 2"
                large:
                    masters: "count >= 3, cpu >= 2"
                    nodes:   "count >= 3, cpu >= 2"
            k8s:
                small:
                    masters: "cpu >= 2"
                    nodes:   "cpu >= 2"
                normal:
                    masters: "count >= 3, cpu >= 2"
                    nodes:   "count >= 3, cpu >= 2"
                large:
                    masters: "count >= 5, cpu >= 2"
                    nodes:   "count >= 8, cpu >= 2"

    parameters:
        - AllowPodsOnMasters=false
        - AllowPodsOnGateways=false
        - CNI=calico
        - Dashboard=true
        - Hardening=true
        - KubeVersion=1.14.10
        - HelmVersion=2.15.2
        - DisableHelm=false
        - HelmDefaultNamespace=default
        - ExternalLoadBalancerHostname=
        - OIDCRealm=
        - OIDCClientName=default
        - OIDCGroupName=user_groups
        - OIDCUserName=username
        - ControlplaneEndpointIP
        - PODSubnet=10.244.0.0/16
        - ServiceSubnet=10.96.0.0/12

    install:
        bash:
            check:
                pace: nodes,kube
                steps:
                    nodes:
                        targets:
                            gateways: all
                            nodes: all
                        run: |
                            if [ -f /etc/kubernetes/.joined ]; then
                                pidof kubelet &>/dev/null || sfFail 192 "kubelet not running"
                                sfExit
                            fi
                            sfFail 193 "node didn't join (no .joined file)"

                    kube:
                        targets:
                            masters: one
                        run: |
                            if [ -f /etc/kubernetes/.joined ]; then
                                [ $(sfKubectl get nodes -A | wc -l) -gt 1 ] || sfFail 194
                                sfExit
                            fi
                            sfFail 196

            add:
                pace: sysconf,syshardening,common-tools,ca,halb,cp1-init,cni,cpx-init,join-gws,join-nodes,final
                steps:
                    sysconf:
                        targets:
                            gateways: all
                            masters: all
                            nodes: all
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            # Enabling kernel modules required by Kubernetes
                            for i in ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh br_netfilter; do
                                echo $i >>/etc/modules-load.d/kubernetes.conf
                                modprobe $i 2>/dev/null || sfFail 201 "Error enabling kernel module $i, error code $?"
                            done
    
                            op=-1
                            for i in nf_conntrack_ipv4 nf_conntrack; do
                                echo $i >>/etc/modules
                                modprobe $i 2>/dev/null && op=0 || true
                            done
                            if [ $op -eq -1 ]; then
                                sfFail 201 "Error enabling kernel module nf_conntrack and nf_conntrack_ipv4"
                            fi

                            case $LINUX_KIND in
                                debian|ubuntu)
                                    sfWaitForApt
                                    sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfApt install -y ebtables socat || sfFail 192
                                    ;;
                                redhat|rhel|fedora|centos)
                                    sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} yum install -y ebtables socat || sfFail 193

                                    cat >/etc/sysctl.d/kubernetes.conf <<-'EOF'
                            net.bridge.bridge-nf-call-ip6tables = 1
                            net.bridge.bridge-nf-call-iptables = 1
                            net.bridge.bridge-nf-call-arptables = 1
                            EOF

                                    # Set SELinux in permissive mode (effectively disabling it)
                                    if [[ -n $(command -v getenforce) ]]; then
                                        act=0
                                        getenforce | grep "Disabled" || act=1
                                        if [ $act -eq 1 ]; then
                                            if [[ -n $(command -v setenforce) ]]; then
                                                setenforce 0 || sfFail 201 "Error setting selinux in Permissive mode"
                                                sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
                                            fi
                                        fi
                                    fi
                                    ;;
                                *)
                                    echo "Unmanaged Linux distribution '$LINUX_KIND'"
                                    sfFail 194
                                    ;;
                            esac

                            kernel_version=$(cat /proc/version | awk '{ print $3 }' | cut -d. -f1)

                            echo "net.ipv4.ip_forward=1" >>/etc/sysctl.d/99-sysctl.conf
                            sysctl --system

                            # Disable swap if enabled
                            op=-1
                            SWAPS=$(grep "swap[[:space:]]*sw[[:space:]]*" /etc/fstab | column -t | cut -d' ' -f1) && op=$? || true
                            if [ $op -eq 0 ]; then
                                cp /etc/fstab /etc/fstab.before_swap_disable
                                for s in $SWAPS; do
                                    swapoff $s &>/dev/null
                                    grep -v "$s" /etc/fstab >>/etc/fstab.new && mv /etc/fstab.new /etc/fstab
                                done
                            fi
                            sfExit

                    syshardening:
                        targets:
                            gateways: all
                            masters: all
                            nodes: all
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            {{ if eq .Hardening "true" }}
                            case $(sfGetFact "linux_kind") in
                                debian|ubuntu)
                                    sfApt update
                                    sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfApt install -y auditd quota quotatool || sfFail 195
                                    ;;

                                centos|fedora|redhat|rhel)
                                    sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} yum -y install audit audit-libs quota || sfFail 195
                                    ;;

                                *) echo "unsupported linux distribution '$(sfGetFact "linux_kind")'"
                                   sfFail 196
                                   ;;
                            esac

                            ## Configures ulimit - not compatible with a host on which a user graphical system is used - like remote desktop...
                            # cat >> /etc/security/limits.conf <<EOF
                            # *      soft      nproc      100
                            # *      hard      nproc      200
                            # *      soft      nofile      1024
                            # *      hard      nofile      2048
                            # EOF

                            ## Configures audit rules
                            cat >/etc/audit/rules.d/docker.rules <<EOF
                            -w /usr/bin/docker -p awx -k docker_binary
                            -w /var/lib/docker -p aw -k docker_data
                            -w /etc/docker -p aw -k docker_configuration
                            -w /etc/docker/daemon.json -p aw -k docker_daemon
                            -w /etc/default/docker -p aw -k docker_default
                            -w /usr/bin/containerd -p awx -k docker_containerd
                            -w /usr/bin/runc -p awx -k docker_runc
                            EOF
                            sfService restart auditd

                            # Disable docker swarm
                            cat /etc/docker/daemon.json | jq '. + { "swarm-default-advertise-addr": "" }' >/etc/docker/daemon.json.new && \
                            mv /etc/docker/daemon.json.new /etc/docker/daemon.json && \
                            sfService restart docker || sfFail 198 "failed to disable docker swarm"
                            {{ end }}
                            sfExit

                    common-tools:
                        targets:
                            gateways: all
                            masters: all
                            nodes: all
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            case $(sfGetFact "linux_kind") in
                                debian|ubuntu)
                                    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
                                    cat >/etc/apt/sources.list.d/kubernetes.list <<-EOF
                            deb https://apt.kubernetes.io/ kubernetes-xenial main
                            EOF
                            {{ if .KubeVersion }}
                                    sfApt update && sfApt install -y kubelet={{.KubeVersion}}-00 kubeadm={{.KubeVersion}}-00 kubectl={{.KubeVersion}}-00 || sfFail 199
                            {{ else }}
                                    sfApt update && sfApt install -y kubelet kubeadm kubectl || sfFail 199
                            {{ end }}
                                    apt-mark hold kubelet kubeadm kubectl
                                    ;;

                                centos|fedora|redhat|rhel)
                                    cat >/etc/yum.repos.d/kubernetes.repo <<-EOF
                            [kubernetes]
                            name=Kubernetes
                            baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
                            enabled=1
                            gpgcheck=1
                            repo_gpgcheck=1
                            gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
                            exclude=kube*
                            EOF

                            {{ if .KubeVersion }}
                                    yum -y install kubelet-{{.KubeVersion}} kubeadm-{{.KubeVersion}} kubectl-{{.KubeVersion}} --disableexcludes=kubernetes || sfFail 199
                            {{ else }}
                                    yum -y install kubelet kubeadm kubectl --disableexcludes=kubernetes || sfFail 199
                            {{ end }}
                                    ;;

                                *) echo "unsupported linux distribution ''"
                                   sfFail 200
                            esac
                            sfService enable kubelet && sfService start kubelet

                            sfExit

                    halb:
                        targets:
                            masters: all
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            {{ if .ControlplaneUsesVIP }}
                            case $(sfGetFact "linux_kind") in
                                ubuntu|debian)
                                    sfApt update && sfApt -y install keepalived haproxy || sfFail 202
                                    ;;
                                redhat|rhel|centos|fedora)
                                    yum install -q -y keepalived haproxy || sfFail 202
                                    ;;
                                *)
                                    sfFail 203 "Unsupported Linux distribution '$(sfGetFact "linux_kind")'!"
                                    ;;
                            esac

                            NETMASK=$(echo {{ .CIDR }} | cut -d/ -f2)
                            IDX={{ .Hostname }}
                            IDX=${IDX##*-}
                            cat >/etc/keepalived/keepalived.conf <<-EOF
                            vrrp_instance vrrp_group_controlplane {
                                state BACKUP
                                interface $(sfInterfaceWithIP {{ .HostIP }})
                                virtual_router_id 1
                                priority ${IDX}
                                nopreempt
                                advert_int 2
                                authentication {
                                    auth_type PASS
                                    auth_pass "{{ .ClusterAdminPassword }}"
                                }
                                # Unicast specific option, this is the IP of the interface keepalived listens on
                                unicast_src_ip {{ .HostIP }}
                                # Unicast specific option, this is the IP of the peer instance
                                unicast_peer {
                                  {{- range .ClusterMasterIPs }}
                                    {{ if ne . $.HostIP }}{{ . }}{{ end }}
                                  {{- end }}
                                }
                                virtual_ipaddress {
                                    {{ .ControlplaneEndpointIP }}/${NETMASK}
                                }
                            }
                            EOF
                            chown -R root:root /etc/keepalived
                            chmod -R u+rw,g+r-w,o-rwx /etc/keepalived
                            chmod ug+x /etc/keepalived

                            cat >/etc/sysctl.d/22-keepalived.conf <<-EOF
                            net.ipv4.ip_forward=1
                            net.ipv4.ip_nonlocal_bind=1
                            EOF
                            sysctl --system

                            if [ "$(sfGetFact "use_systemd")" = "1" ]; then
                                # Use systemd to ensure keepalived is restarted if network is restarted
                                # (otherwise, keepalived is in undetermined state)
                                mkdir -p /etc/systemd/system/keepalived.service.d
                                if [ "$(sfGetFact "redhat_like")" = "1" ]; then
                                    cat >/etc/systemd/system/keepalived.service.d/override.conf <<EOF
                            [Unit]
                            Requires=network.service
                            PartOf=network.service
                            EOF
                                else
                                    cat >/etc/systemd/system/keepalived.service.d/override.conf <<EOF
                            [Unit]
                            Requires=systemd-networkd.service
                            PartOf=systemd-networkd.service
                            EOF
                                fi
                                systemctl daemon-reload
                            fi

                            sfService enable keepalived
                            sfService restart keepalived || sfFail 204

                            ## Configure haproxy as TCP load-balancer for kubernetes Control Plane
                            cat >/etc/haproxy/haproxy.cfg <<-EOF
                            global
                                log /dev/log    local0
                                log /dev/log    local1 notice
                                chroot /var/lib/haproxy
                                stats socket /var/local/haproxy/admin.sock mode 660 level admin
                                stats timeout 30s
                                user haproxy
                                group haproxy
                                pidfile     /var/run/haproxy.pid
                                maxconn     4000
                                daemon

                                # Default SSL material locations
                                ca-base /etc/ssl/certs
                                crt-base /etc/ssl/private

                                # Default ciphers to use on SSL-enabled listening sockets.
                                # For more information, see ciphers(1SSL). This list is from:
                                #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
                                # An alternative list with additional directives can be obtained from
                                #  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy
                                ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
                                ssl-default-bind-options no-sslv3

                            defaults
                                mode tcp
                                log global
                                option httplog
                                option dontlognull
                                option http-server-close
                                option redispatch
                                retries 3
                                timeout http-request    10s
                                timeout queue           1m
                                timeout connect         10s
                                timeout client          1m
                                timeout server          1m
                                timeout http-keep-alive 10s
                                timeout check           10s
                                maxconn                 3000

                            listen kube_controlplane
                                bind {{ .ControlplaneEndpointIP }}:6443
                                mode tcp
                                option tcplog
                                timeout client 10m
                                timeout server 10m
                                balance leastconn
                                {{- range $i, $ip := .ClusterMasterIPs }}
                                server cp{{ $i }} {{.}}:6444 check fall 3 rise 2
                                {{- end }}
                            EOF
                            mkdir -p /var/local/haproxy
                            sfService enable haproxy
                            sfService restart haproxy || sfFail 205
                            {{ end }}
                            sfExit

                    ca:
                        targets:
                            masters: one
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            mkdir -p /etc/kubernetes/pki
                            if [ -f ${SF_ETCDIR}/pki/ca/certs/rootca.cert.pem ]; then
                                [ -f /etc/kubernetes/pki/ca.crt ] && mv /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/ca.crt.notused
                                [ -f /etc/kubernetes/pki/ca.key ] && mv /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/ca.key.notused
                                cp ${SF_ETCDIR}/pki/ca/certs/rootca.cert.pem /etc/kubernetes/pki/ca.crt
                                cp ${SF_ETCDIR}/pki/ca/private/rootca.key.pem /etc/kubernetes/pki/ca.key
                            fi
                            chown -R root:{{ .ClusterAdminUsername }} /etc/kubernetes/pki
                            sfExit

                    cp1-init:
                        targets:
                            masters: one
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            mkdir -p /etc/kubernetes/kubeadm

                            {{ if .KubeVersion }}
                            KUBE_VERSION=v{{ .KubeVersion }}
                            {{ else }}
                            KUBE_VERSION=stable
                            {{ end }}

                            {{ if .ControlplaneUsesVIP }}
                            LOCAL_PORT=6444
                            CP_ENDPOINT_IP={{ .ControlplaneEndpointIP}}
                            {{ else }}
                            LOCAL_PORT=6443
                            CP_ENDPOINT_IP={{ .HostIP }}
                            {{ end }}

                            DNSDOMAIN=$(hostname -d)
                            [ -z "${DNSDOMAIN}" ] && DNSDOMAIN=cluster.local

                            cat >/etc/kubernetes/kubeadm/kubeadm-config.yaml <<-EOF
                            ---
                            apiVersion: kubeadm.k8s.io/v1beta1
                            kind: ClusterConfiguration
                            controlPlaneEndpoint: "${CP_ENDPOINT_IP}:6443"
                            kubernetesVersion: ${KUBE_VERSION}
                            etcd:
                                local:
                                    dataDir: /var/lib/etcd
                            networking:
                                dnsDomain: ${DNSDOMAIN}
                                podSubnet: {{ .PODSubnet }}
                                serviceSubnet: {{ .ServiceSubnet }}
                            {{- if eq .Hardening "true" }}
                            apiServer:
                                timeoutForControlPlane: 4m0s
                                extraArgs:
                                    #? API server is restarted because of health check fail
                                    #? Modern K8S deploys preferes RBAC admission associate to PodSecurityPolicy to authorization control
                                    # anonymous-auth: "false"
                                    ##? EventRateLimit error running kubeadm init, alpha version
                                    ##? DenyEscalatingExec, deprecated
                                    enable-admission-plugins: AlwaysPullImages,DefaultStorageClass,NamespaceLifecycle,ServiceAccount,NodeRestriction,PodSecurityPolicy
                                    ## disable-admission-plugins: DynamicAuditing
                                    ##? error running kubeadm init
                                    # RBAC is used to grant permission to client, restrict access to anonymous users
                                    authorization-mode: RBAC,Node
                                    #!allow-privileged: "false"
                                    ##? kube-proxy cannot be run
                                    ##? RBAC admission provide fine grained control
                                    audit-log-path: /var/log/k8s_audit.log
                                    audit-log-maxage: "30"
                                    audit-log-maxbackup: "10"
                                    audit-log-maxsize: "100"
                                    service-account-lookup: "true"
                                    #? crash during init phase, to be investigated ...
                                    ## encryption-provider-config: aescbc
                                    profiling: "false"
                            {{- end }}
                            controllerManager:
                                extraArgs:
                                    terminated-pod-gc-threshold: "12500"
                            {{- if eq .Hardening "true" }}
                                    profiling: "false"
                                    use-service-account-credentials: "true"
                                    feature-gates: RotateKubeletServerCertificate=true
                            {{- end }}
                                    cluster-signing-cert-file: /etc/kubernetes/pki/ca.crt
                                    cluster-signing-key-file: /etc/kubernetes/pki/ca.key
                            ---
                            apiVersion: kubeadm.k8s.io/v1beta1
                            kind: InitConfiguration
                            localAPIEndpoint:
                                bindPort: ${LOCAL_PORT}
                            certificateDir: /etc/kubernetes/pki
                            clusterName: kubernetes
                            dns:
                                type: CoreDNS
                            imageRepository: k8s.gcr.io
                            {{- if .OIDCRealm }}
                                {{- if .ExternalLoadBalancerHostname }}
                            oidc-issuer-url: "https://{{ .ExternalLoadBalancerHostname }}/realms/{{ .OIDCRealm }}"
                                {{- else }}
                            oidc-issuer-url: "https://{{ .EndpointIP }}/realms/{{ .OIDCRealm }}"
                            # oidc-ca-file: "/opt/safescale/etc/pki/ca/certs/rootca.cert.pem"
                                {{- end }}
                            oidc-client-id: "{{ .OIDCClientName }}"
                            oidc-username-claim: "{{ .OIDCUserName }}"
                            oidc-groups-claim: "{{ .OIDCGroupName }}"
                            {{- end }}
                            ---
                            apiVersion: kubeproxy.config.k8s.io/v1alpha1
                            kind: KubeProxyConfiguration
                            metricsBindAddress: 0.0.0.0:10249
                            EOF

                            sfRetry {{.TemplatePullImagesTimeout}} {{.TemplateOperationDelay}} kubeadm config images pull || sfFail 202
                            sudo kubeadm init --config=/etc/kubernetes/kubeadm/kubeadm-config.yaml || sfFail 203
                            cp_join_cmd=$(kubeadm token create --ttl 10m --print-join-command) || sfFail 204
                            cert_key=$(kubeadm init phase upload-certs --experimental-upload-certs | tail -n 1) || sfFail 205

                            cat >${SF_TMPDIR}/init_cluster_admin_kube.sh <<-'EOF'
                            mkdir -p ~{{.ClusterAdminUsername}}/.kube
                            cp -f /etc/kubernetes/admin.conf ~{{.ClusterAdminUsername}}/.kube/config
                            chown -R {{.ClusterAdminUsername}}:{{.ClusterAdminUsername}} ~{{.ClusterAdminUsername}}/.kube && \
                            chmod -R go-rwx ~{{.ClusterAdminUsername}}/.kube

                            sudo chown root:{{.ClusterAdminUsername}} /etc/kubernetes/pki/etcd/
                            sudo chown root:{{.ClusterAdminUsername}} /etc/kubernetes/pki/etcd/ca.crt
                            sudo chown root:{{.ClusterAdminUsername}} /etc/kubernetes/pki/etcd/server.key
                            sudo chmod g+r /etc/kubernetes/pki/etcd/server.key
                            sudo chown root:{{.ClusterAdminUsername}} /etc/kubernetes/pki/etcd/server.crt
                            EOF

                            # execute init_cluster_admin_kube.sh on the current master
                            bash ${SF_TMPDIR}/init_cluster_admin_kube.sh || sfFail 206
                            # Starting from here, any kubectl command must be changed to sfKubectl

                            # Push control-plane join command to all the other masters
                            cat >${SF_TMPDIR}/cp_join_cmd.sh <<-EOF
                            kubeadm reset --force
                            $cp_join_cmd --experimental-control-plane --certificate-key $cert_key --apiserver-bind-port $LOCAL_PORT
                            EOF
                            sfDropzonePush ${SF_TMPDIR}/cp_join_cmd.sh || fail 207
                            sfDropzonePush ${SF_TMPDIR}/init_cluster_admin_kube.sh || fail 208
                            for ip in {{range .ClusterMasterIPs}}{{.}} {{end}}; do
                                [ "$ip" = "{{.HostIP}}" ] && continue
                                sfDropzoneSync $ip || sfFail 209
                            done
                            rm ${SF_TMPDIR}/cp_join_cmd.sh ${SF_TMPDIR}/init_cluster_admin_kube.sh
                            sfDropzoneClean

                            {{ if eq .Hardening "true" }}
                            # define and apply Pod Security Polices (PSP)
                            cat >/etc/kubernetes/kubeadm/psp-default.yaml <<-'EOF'
                            apiVersion: extensions/v1beta1
                            kind: PodSecurityPolicy
                            metadata:
                              name: default
                              annotations:
                                seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'docker/default'
                                seccomp.security.alpha.kubernetes.io/defaultProfileName:  'docker/default'
                            spec:
                              privileged: false
                              allowPrivilegeEscalation: false
                              allowedCapabilities: []  # default set of capabilities are implicitly allowed
                              volumes:
                              - 'configMap'
                              - 'emptyDir'
                              - 'projected'
                              - 'secret'
                              - 'downwardAPI'
                              - 'persistentVolumeClaim'
                              hostNetwork: false
                              hostIPC: false
                              hostPID: false
                              runAsUser:
                                rule: 'RunAsAny'
                              seLinux:
                                rule: 'RunAsAny'
                              supplementalGroups:
                                rule: 'RunAsAny'
                              fsGroup:
                                rule: 'RunAsAny'
                            ---
                            kind: ClusterRole
                            apiVersion: rbac.authorization.k8s.io/v1
                            metadata:
                              name: default-psp
                            rules:
                            - apiGroups: ['policy']
                              resources: ['podsecuritypolicies']
                              verbs:     ['use']
                              resourceNames: ['default']
                            - apiGroups: ['extensions']
                              resources: ['podsecuritypolicies']
                              verbs:     ['use']
                              resourceNames: ['default']
                            ---
                            kind: ClusterRoleBinding
                            apiVersion: rbac.authorization.k8s.io/v1
                            metadata:
                              name: default-psp
                            roleRef:
                              kind: ClusterRole
                              name: default-psp
                              apiGroup: rbac.authorization.k8s.io
                            subjects:
                            - kind: Group
                              name: system:authenticated
                              apiGroup: rbac.authorization.k8s.io
                            EOF

                            cat >/etc/kubernetes/kubeadm/psp-privileged.yaml <<-'EOF'
                            apiVersion: extensions/v1beta1
                            kind: PodSecurityPolicy
                            metadata:
                              name: privileged
                              annotations:
                                seccomp.security.alpha.kubernetes.io/allowedProfileNames: '*'
                            spec:
                              privileged: true
                              allowPrivilegeEscalation: true
                              allowedCapabilities: ['*']
                              volumes: ['*']
                              hostNetwork: true
                              hostPorts:
                              - min: 0
                                max: 65535
                              hostIPC: true
                              hostPID: true
                              runAsUser:
                                rule: 'RunAsAny'
                              seLinux:
                                rule: 'RunAsAny'
                              supplementalGroups:
                                rule: 'RunAsAny'
                              fsGroup:
                                rule: 'RunAsAny'
                            ---
                            kind: RoleBinding
                            apiVersion: rbac.authorization.k8s.io/v1
                            metadata:
                              name: privileged-psp-nodes
                              namespace: kube-system
                            roleRef:
                              kind: ClusterRole
                              name: privileged-psp
                              apiGroup: rbac.authorization.k8s.io
                            subjects:
                            # Allows access to resources required by the kubelet component
                            - kind: Group
                              apiGroup: rbac.authorization.k8s.io
                              name: system:nodes
                            # Allows access to resources required by the kubelet user
                            - kind: User
                              apiGroup: rbac.authorization.k8s.io
                              name: kubelet # Legacy node ID
                            # bind all service accounts in namespace kube-system (kube-proxy, CNI)
                            - apiGroup: rbac.authorization.k8s.io
                              kind: Group
                              name: system:serviceaccounts:kube-system
                            ---
                            kind: ClusterRole
                            apiVersion: rbac.authorization.k8s.io/v1
                            metadata:
                              name: privileged-psp
                            rules:
                            - apiGroups: ['policy']
                              resources: ['podsecuritypolicies']
                              verbs:     ['use']
                              resourceNames: ['privileged']
                            - apiGroups: ['extensions']
                              resources: ['podsecuritypolicies']
                              verbs:     ['use']
                              resourceNames: ['privileged']
                            EOF

                            sfKubectl apply -f /etc/kubernetes/kubeadm/psp-default.yaml || sfFail 204
                            sfKubectl apply -f /etc/kubernetes/kubeadm/psp-privileged.yaml || sfFail 205
                            {{ end }}

                            # waits availability of key pods
                            set -u -o pipefail
                            sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfIsPodRunning kube-apiserver-{{.Hostname}}@kube-system || sfFail 212
                            sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfIsPodRunning kube-controller-manager-{{.Hostname}}@kube-system || sfFail 213
                            sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfIsPodRunning kube-scheduler-{{.Hostname}}@kube-system || sfFail 214

                            echo "cp1 init done"
                            sfExit

                    cni:
                        targets:
                            masters: one
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            case {{ .CNI }} in
                                flannel) # To be removed
                                    sfKubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml || sfFail 215

                                    sfFirewallAdd --zone=trusted --add-interface=flannel.1
                                    sfFirewallAdd --zone=trusted --add-interface=cni0
                                    sfFirewallReload || sfFail 216 "Firewall problem"
                                    ;;
                                calico)
                                    # Should already exist...
                                    mkdir -p /etc/kubernetes/kubeadm/

                                    # Applies RBAC Calico
                                    wget https://docs.projectcalico.org/v3.10/manifests/rbac/rbac-kdd-calico.yaml -P /etc/kubernetes/kubeadm/
                                    sfKubectl apply -f /etc/kubernetes/kubeadm/rbac-kdd-calico.yaml || sfFail 219

                                    # Downloads default calico
                                    wget https://docs.projectcalico.org/v3.10/manifests/calico.yaml -P /etc/kubernetes/kubeadm/ || sfFail 220

                                    # Creates our patch file
                                    cat >/etc/kubernetes/kubeadm/calico.yaml.patch <<-'EOF'
                            --- calico.yaml	2019-11-21 17:06:25.590230285 +0100
                            +++ calico.yaml.new	2019-11-21 17:02:11.885017690 +0100
                            @@ -24,7 +24,7 @@
                                  "plugins": [
                                    {
                                      "type": "calico",
                            -          "log_level": "info",
                            +          "log_level": "debug",
                                      "datastore_type": "kubernetes",
                                      "nodename": "__KUBERNETES_NODE_NAME__",
                                      "mtu": __CNI_MTU__,
                            @@ -606,6 +606,10 @@
                                          value: "autodetect"
                                        # Enable IPIP
                                        - name: CALICO_IPV4POOL_IPIP
                            +              value: "Never"
                            +            - name: FELIX_VXLANVNI
                            +              value: "4095"
                            +            - name: CALICO_IPV4POOL_VXLAN
                                          value: "Always"
                                        # Set MTU for tunnel device used if ipip is enabled
                                        - name: FELIX_IPINIPMTU
                            @@ -619,7 +621,7 @@
                                        # chosen from this range. Changing this value after installation will have
                                        # no effect. This should fall within `--cluster-cidr`.
                                        - name: CALICO_IPV4POOL_CIDR
                            -              value: "192.168.0.0/16"
                            +              value: "10.244.0.0/16"
                                        # Disable file logging so `kubectl logs` works.
                                        - name: CALICO_DISABLE_FILE_LOGGING
                                          value: "true"
                            EOF

                                    # Installs the 'patch' command
                                    case $(sfGetFact "linux_kind") in
                                        debian|ubuntu)
                                            sfApt update && sfApt install -y patch || sfFail 221
                                            ;;

                                        centos|fedora|redhat|rhel)
                                            yum -y install patch || sfFail 222
                                            ;;

                                        *) echo "unsupported linux distribution ''"
                                           sfFail 223
                                           ;;
                                    esac

                                    # Patches calico file
                                    patch -l /etc/kubernetes/kubeadm/calico.yaml /etc/kubernetes/kubeadm/calico.yaml.patch

                                    # Applies patched file
                                    sfKubectl apply -f /etc/kubernetes/kubeadm/calico.yaml || sfFail 224

                                    sfFirewallAdd --zone=trusted --add-interface=cni0
                                    sfFirewallReload || sfFail 225 "Firewall problem"
                                    ;;
                            esac

                            touch /etc/kubernetes/.joined
                            sfExit 0

                    cpx-init:
                        targets:
                            masters: all
                        serialized: true
                        run: |
                            # Don't try to init a kubernetes cluster already running
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            sfDropzonePop ${SF_TMPDIR} || sfFail 223
                            sfDropzoneClean

                            [ -f ${SF_TMPDIR}/cp_join_cmd.sh ] || sfFail 227
                            # sometimes, etcd cluster appears to be unhealthy when calling this... So retries!
                            sfRetry {{.TemplateLongOperationTimeout}} {{.TemplateOperationDelay}} bash ${SF_TMPDIR}/cp_join_cmd.sh || sfFail 228
                            [ -f ${SF_TMPDIR}/init_cluster_admin_kube.sh ] || sfFail 229
                            bash ${SF_TMPDIR}/init_cluster_admin_kube.sh || sfFail 230

                            # waits availability of key pods
                            set -u -o pipefail
                            sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfIsPodRunning kube-apiserver-{{.Hostname}}@kube-system || sfFail 228
                            sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfIsPodRunning kube-controller-manager-{{.Hostname}}@kube-system || sfFail 229
                            sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfIsPodRunning kube-scheduler-{{.Hostname}}@kube-system || sfFail 230

                            # Configure firewall
                            case {{.CNI}} in
                                flannel)
                                    sfFirewallAdd --zone=trusted --add-interface=flannel.1
                                    sfFirewallAdd --zone=trusted --add-interface=cni0
                                    sfFirewallReload || sfFail 231 "Firewall problem"
                                    ;;
                                calico)
                                    sfFirewallAdd --zone=trusted --add-interface=cni0
                                    sfFirewallReload || sfFail 235 "Firewall problem"
                                    ;;
                            esac

                            touch /etc/kubernetes/.joined
                            echo "cpx init done"
                            sfExit

                    join-gws:
                        targets:
                            gateways: all
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            MASTERIP=
                            for m in {{ range .ClusterMasterIPs }}{{.}} {{ end -}}; do
                                op=-1
                                NODE_JOIN_CMD=$(sfRemoteExec $m kubeadm token create --print-join-command) && op=$? || true
                                [ $op -ne 0 ] && continue
                                NODE_JOIN_CMD=$(echo $NODE_JOIN_CMD | head -1)
                                MASTERIP=$m
                                break
                            done
                            [ -z "$MASTERIP" ] && echo "failed to find available master to register with. Aborted." && sfFail 233
                            eval $NODE_JOIN_CMD || sfFail 234

                            sfRemoteExec $MASTERIP sudo -u {{ .ClusterAdminUsername }} -i kubectl taint nodes {{ .Hostname }} key=value:NoSchedule || sfFail 235

                            touch /etc/kubernetes/.joined
                            sfExit

                    join-nodes:
                        targets:
                            nodes: all
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            MASTERIP=
                            for m in {{ range .ClusterMasterIPs }}{{.}} {{ end -}}; do
                                op=-1
                                NODE_JOIN_CMD=$(sfRemoteExec $m kubeadm token create --print-join-command) && op=$? || true
                                [ $op -ne 0 ] && continue
                                NODE_JOIN_CMD=$(echo $NODE_JOIN_CMD | head -1)
                                MASTERIP=$m
                                break
                            done
                            [ -z "$MASTERIP" ] && echo "failed to find available master to register with. Aborted." && sfFail 233
                            eval $NODE_JOIN_CMD || sfFail 234

                            touch /etc/kubernetes/.joined
                            sfExit

                    final:
                        targets:
                            masters: one
                        run: |
                            [ -f /etc/kubernetes/.joined ] && sfExit

                            # Allows pods to start on master if there is only one master or if it's explicitely requested
                            if [ "{{.ClusterComplexity}}" = "small" -o "{{.AllowPodsOnMasters}}" = "true" ]; then
                                sfKubectl taint nodes --all node-role.kubernetes.io/master- || true
                            fi

                            # Adds namespace safescale
                            sfKubectl create namespace safescale
                            # FIXME: add label to namespace (in prevision of network policies)
                            # sfKubectl set label
                            # adds Kubernetes Dashboard
                            if [ "{{.Dashboard}}" == "true" ]; then
                                if curl --output /dev/null --silent --head --fail "https://raw.githubusercontent.com/kubernetes/dashboard/$(sfGithubLastRelease kubernetes dashboard)/src/deploy/recommended/kubernetes-dashboard.yaml"; then
                                    sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfKubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/$(sfGithubLastRelease kubernetes dashboard)/src/deploy/recommended/kubernetes-dashboard.yaml || sfFail 254 "Unable to install kubernetes dashboard version $(sfGithubLastRelease)"
                                else
                                    if curl --output /dev/null --silent --head --fail "https://raw.githubusercontent.com/kubernetes/dashboard/$(sfGithubLastNotBetaRelease kubernetes dashboard)/src/deploy/recommended/kubernetes-dashboard.yaml"; then
                                        sfRetry {{.TemplateOperationTimeout}} {{.TemplateOperationDelay}} sfKubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/$(sfGithubLastNotBetaRelease kubernetes dashboard)/src/deploy/recommended/kubernetes-dashboard.yaml || sfFail 255 "Unable to install kubernetes dashboard version $(sfGithubLastNotBetaRelease)"
                                    fi
                                fi
                            fi
                            sfExit

            remove:
                pace: node,reset,clean
                steps:
                    node:
                        targets:
                            masters: one
                        run: |
                            sfKubectl drain {{.Hostname}} --delete-local-data --force --ignore-daemonsets
                            sfKubectl delete node {{.Hostname}}
                            sfExit

                    reset:
                        targets:
                            gateways: all
                            masters: all
                            nodes: all
                        run: |
                            kubeadm reset -f
                            sfExit

                    clean:
                        targets:
                            gateways: all
                            masters: all
                            nodes: all
                        run: |
                            case $LINUX_KIND in
                                debian|ubuntu)
                                    sfApt purge -y kubectl kubeadm kubelet || sfFail 223 "failure purging kubernetes"
                                    ;;
                                redhat|rhel|fedora|centos)
                                    yum remove -y kubectl kubeadm kubelet || sfFail 224 "failure purging kubernetes"
                                    ;;
                            esac
                            sfFirewallReload || sfFail 225 "Firewall problem"
                            rm -f /etc/kubernetes/.joined
                            sfExit

...
